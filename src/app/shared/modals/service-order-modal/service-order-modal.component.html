<div class="modal-wrapper">
    <div class="modal-header flex justify-between items-center mb-4 pb-4 border-b border-gray-200">
        <div>
            <h2 class="text-2xl font-bold text-gray-800">
                <span *ngIf="!readonly">{{ serviceOrder ? "Editar Ordem de Serviço" : "Nova Ordem de Serviço" }}</span>
                <span *ngIf="readonly">Detalhes da Ordem de Serviço</span>
                <span *ngIf="serviceOrderData._id" class="ml-2 text-base font-medium text-gray-500">#{{ serviceOrderData.orderNumber }}</span>
            </h2>
            <p class="text-sm text-gray-500 mt-1">
                <span *ngIf="!readonly">{{
                    serviceOrder
                        ? "Atualize os dados da ordem de serviço"
                        : "Registre uma nova
                    ordem de serviço"
                }}</span>
                <span *ngIf="readonly">Visualizando informações detalhadas da ordem de serviço</span>
            </p>
        </div>
        <button type="button" (click)="closeModal()" class="text-gray-400 hover:text-gray-600 focus:outline-none transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>
    </div>

    <div *ngIf="readonly" class="bg-blue-50 text-blue-700 px-3 py-2 rounded-md mb-4 flex items-center justify-between">
        <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Você está no modo visualização. Os campos não podem ser editados.</span>
        </div>
        <button type="button" (click)="enableEditing()" class="bg-blue-600 text-white py-1 px-3 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
            </svg>
            Editar
        </button>
    </div>

    <div class="status-container mb-4 flex items-center justify-between">
        <div class="flex items-center">
            <span class="text-sm font-medium text-gray-700 mr-2">Status atual:</span>
            <span class="px-2 py-1 text-xs font-medium rounded-full" [ngClass]="getStatusColorClass(serviceOrderData.status)">
                {{ getStatusLabel(serviceOrderData.status) }}
            </span>
        </div>
    </div>

    <app-service-order-stepper [currentStatus]="serviceOrderData.status" (changeTabEvent)="changeTab($event)" [readonly]="readonly"> </app-service-order-stepper>

    <form (ngSubmit)="saveServiceOrder()">
        <div class="modal-content">
            <div [ngSwitch]="selectedTab">

                <app-service-order-opening *ngSwitchCase="'general'" [serviceOrderData]="serviceOrderData" [selectedVehiclePlate]="selectedVehiclePlate" [selectedClientName]="selectedClientName" [readonly]="readonly" (vehicleSelected)="onVehicleSelected($event)"> </app-service-order-opening>

                <app-service-order-diagnosis *ngSwitchCase="'diagnosis'" #diagnosisComponent [serviceOrderData]="serviceOrderData" [readonly]="readonly" [isLoading]="isLoading" [showGenerateBudgetButton]="shouldShowGenerateBudgetButton()" [selectedClientName]="selectedClientName" [approvalLink]="approvalLink" (partsOrServicesChanged)="onBudgetModified()" (generateDiagnosticAndBudgetEvent)="processGenerateDiagnosticAndBudget()" (startDiagnosisEvent)="startDiagnosis()" (shareBudgetEvent)="shareBudgetWithClient()" (approveBudgetEvent)="approveBudget()" (rejectBudgetEvent)="rejectBudget()" (cancelEvent)="closeModal()" (share)="onShareMethodSelected($event)"> </app-service-order-diagnosis>

                <app-service-order-execution *ngSwitchCase="'execution'" [serviceOrderData]="serviceOrderData" [readonly]="readonly" [isLoading]="isLoading" [statusOptions]="statusOptions" (updateStatusEvent)="updateStatus($event)" (completeServiceOrderEvent)="completeServiceOrder()"> </app-service-order-execution>

                <app-service-order-completion *ngSwitchCase="'completion'" [serviceOrderData]="serviceOrderData" [readonly]="readonly" [isLoading]="isLoading" (deliverVehicleEvent)="deliverVehicle()"> </app-service-order-completion>
            </div>
        </div>

        <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-4 pt-4 mt-6 border-t border-gray-200 pb-6">
            <button type="button" (click)="closeModal()" class="mt-3 sm:mt-0 w-full sm:w-auto inline-flex justify-center items-center px-4 py-2 border border-gray-300 shadow-sm text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#EC9253] transition duration-200">
                {{ readonly ? "Fechar" : "Cancelar" }}
            </button>

            <button *ngIf="!readonly && selectedTab === 'general' && !serviceOrderData._id" type="button" (click)="saveAndStartDiagnosis()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                <span *ngIf="!isLoading">Iniciar Diagnóstico</span>
                <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span *ngIf="isLoading">Processando...</span>
            </button>

            <button *ngIf="!readonly && selectedTab === 'general' && serviceOrderData._id && serviceOrderData.status === ServiceOrderStatus.OPENED" type="button" (click)="startDiagnosis()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                <span *ngIf="!isLoading">Iniciar Diagnóstico</span>
                <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span *ngIf="isLoading">Processando...</span>
            </button>

            <button *ngIf="!readonly && selectedTab === 'general'" type="submit" [disabled]="isLoading" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-[#EC9253] hover:bg-[#f78839] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#EC9253] transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed">
                <span *ngIf="!isLoading">Salvar</span>
                <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span *ngIf="isLoading">Processando...</span>
            </button>

            <button *ngIf="!readonly && selectedTab === 'diagnosis' && shouldShowGenerateBudgetButton()" type="button" (click)="generateDiagnosticAndBudget()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                <span *ngIf="!isLoading">Gerar Orçamento</span>
                <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span *ngIf="isLoading">Processando...</span>
            </button>

            <ng-container *ngIf="!readonly && selectedTab === 'diagnosis' && serviceOrderData.status === ServiceOrderStatus.WAITING_APPROVAL && !shouldShowGenerateBudgetButton()">
                <button type="button" (click)="approveBudget()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                    <span *ngIf="!isLoading">Aprovar Orçamento</span>
                    <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span *ngIf="isLoading">Processando...</span>
                </button>
                <button type="button" (click)="rejectBudget()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                    <span *ngIf="!isLoading">Rejeitar Orçamento</span>
                    <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span *ngIf="isLoading">Processando...</span>
                </button>
            </ng-container>

            <ng-container *ngIf="!readonly && selectedTab === 'execution'">
                <button *ngIf="serviceOrderData.status === ServiceOrderStatus.APPROVED" type="button" (click)="updateStatus({ status: ServiceOrderStatus.IN_PROGRESS, notes: 'Iniciando execução do serviço' })" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                    <span>Iniciar Serviço</span>
                </button>

                <button *ngIf="serviceOrderData.status === ServiceOrderStatus.IN_PROGRESS" type="button" (click)="updateStatus({ status: ServiceOrderStatus.WAITING_PARTS, notes: 'Aguardando peças' })" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-orange-500 hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-400 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                    <span>Aguardando Peças</span>
                </button>

                <button *ngIf="serviceOrderData.status === ServiceOrderStatus.WAITING_PARTS" type="button" (click)="updateStatus({ status: ServiceOrderStatus.IN_PROGRESS, notes: 'Retomando serviço' })" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                    <span>Retomar Serviço</span>
                </button>

                <button *ngIf="serviceOrderData.status === ServiceOrderStatus.IN_PROGRESS" type="button" (click)="completeServiceOrder()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-emerald-600 hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                    <span *ngIf="!isLoading">Concluir Serviço</span>
                    <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span *ngIf="isLoading">Processando...</span>
                </button>
            </ng-container>

            <button *ngIf="!readonly && selectedTab === 'completion' && serviceOrderData.status === ServiceOrderStatus.COMPLETED" type="button" (click)="deliverVehicle()" class="w-full sm:w-auto inline-flex justify-center items-center px-6 py-2 border border-transparent shadow-sm text-base font-medium rounded-lg text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-200 disabled:opacity-70 disabled:cursor-not-allowed" [disabled]="isLoading">
                <span *ngIf="!isLoading">Registrar Entrega</span>
                <svg *ngIf="isLoading" class="animate-spin h-5 w-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span *ngIf="isLoading">Processando...</span>
            </button>
        </div>
    </form>
</div>
