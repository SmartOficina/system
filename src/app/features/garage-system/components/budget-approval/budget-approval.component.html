<div class="budget-approval-container">
  <div class="budget-approval-header no-print">
    <div class="logo-container">
      <img src="assets/img/logo-white.png" alt="Smart Oficina Logo" class="h-14">
    </div>
  </div>

  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p class="loading-text">Carregando detalhes do orçamento...</p>
  </div>

  <div *ngIf="!isLoading && hasError" class="error-container">
    <div class="error-icon">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    </div>
    <h2 class="error-title">Ocorreu um erro</h2>
    <p class="error-message">{{ errorMessage }}</p>
    <button (click)="loadBudgetDetails()" class="retry-button">Tentar novamente</button>
  </div>

  <div *ngIf="!isLoading && !hasError && serviceOrder" class="budget-details-container">
    <div class="print-button no-print" (click)="printBudget()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
      </svg>
    </div>

    <div class="budget-order-header">
      <h1 class="budget-title">Orçamento</h1>
      <div class="order-number">OS #{{ serviceOrder.orderNumber }}</div>
      <div class="status-container">
        <div class="status-badge" [ngClass]="getStatusClass(serviceOrder.status)">
          {{ getStatusLabel(serviceOrder.status) }}
        </div>
        <div class="status-explanation mt-2 text-sm text-gray-600">
          <span *ngIf="serviceOrder.status === 'aguardando_aprovacao'">
            Este orçamento está aguardando sua aprovação. Por favor, analise os detalhes e clique em "Aprovar" ou
            "Rejeitar" abaixo.
          </span>
          <span *ngIf="serviceOrder.status === 'aprovada'">
            Este orçamento foi aprovado e está pronto para ser executado.
          </span>
          <span *ngIf="serviceOrder.status === 'rejeitada'">
            Este orçamento foi rejeitado. Entre em contato com a oficina para mais informações.
          </span>
          <span *ngIf="serviceOrder.status === 'em_andamento'">
            Este serviço já está em execução na oficina.
          </span>
          <span *ngIf="serviceOrder.status === 'aguardando_pecas'">
            Este serviço está aguardando a chegada de peças para continuar a execução.
          </span>
          <span *ngIf="serviceOrder.status === 'concluida'">
            Este serviço já foi concluído e está aguardando retirada.
          </span>
          <span *ngIf="serviceOrder.status === 'entregue'">
            Este serviço já foi concluído e o veículo foi entregue.
          </span>
        </div>
      </div>
    </div>

    <div class="budget-info-section">
      <div class="budget-info-group">
        <h2 class="section-title">Informações do Cliente</h2>
        <div class="info-row">
          <span class="info-label">Cliente:</span>&nbsp;
          <span class="info-value">{{ serviceOrder.client?.fullName || 'Não informado' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Veículo:</span>&nbsp;
          <span class="info-value">
            {{ serviceOrder.vehicle?.licensePlate || 'N/A' }}
            <ng-container *ngIf="serviceOrder.vehicle?.make || serviceOrder.vehicle?.brandModel">
              - {{ serviceOrder.vehicle?.make }} {{ serviceOrder.vehicle?.brandModel }}
            </ng-container>
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Data de abertura:</span>&nbsp;
          <span class="info-value">{{ serviceOrder.openingDate | date:'dd/MM/yyyy' }}</span>
        </div>
      </div>

      <div class="budget-info-group">
        <h2 class="section-title">Problema Relatado</h2>
        <div class="info-value">{{ serviceOrder.reportedProblem || 'Não informado' }}</div>
      </div>

      <div class="budget-info-group">
        <h2 class="section-title">Problemas Identificados</h2>
        <div *ngIf="!serviceOrder.identifiedProblems || serviceOrder.identifiedProblems.length === 0"
          class="info-empty">
          Nenhum problema adicional identificado
        </div>
        <ul *ngIf="serviceOrder.identifiedProblems && serviceOrder.identifiedProblems.length > 0" class="problem-list">
          <li *ngFor="let problem of serviceOrder.identifiedProblems" class="problem-item">{{ problem }}</li>
        </ul>
      </div>
    </div>

    <div class="budget-details-section">
      <h2 class="section-title">Detalhes do Orçamento</h2>

      <div class="budget-table-container">
        <h3 class="subsection-title">Peças</h3>
        <table class="budget-table">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Quantidade</th>
              <th>Valor Unitário</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!serviceOrder.requiredParts || serviceOrder.requiredParts.length === 0">
              <td colspan="4" class="empty-message">Nenhuma peça adicionada</td>
            </tr>
            <tr *ngFor="let part of serviceOrder.requiredParts">
              <td>{{ part.description }}</td>
              <td class="text-center">{{ part.quantity }}</td>
              <td class="text-right">R$ {{ formatCurrency(part.unitPrice) }}</td>
              <td class="text-right font-medium">R$ {{ formatCurrency(part.totalPrice) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right font-medium">Total Peças:</td>
              <td class="text-right font-bold">R$ {{ formatCurrency(serviceOrder.estimatedTotalParts) }}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="budget-table-container">
        <h3 class="subsection-title">Serviços</h3>
        <table class="budget-table">
          <thead>
            <tr>
              <th>Descrição</th>
              <th>Horas</th>
              <th>Valor/Hora</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngIf="!serviceOrder.services || serviceOrder.services.length === 0">
              <td colspan="4" class="empty-message">Nenhum serviço adicionado</td>
            </tr>
            <tr *ngFor="let service of serviceOrder.services">
              <td>{{ service.description }}</td>
              <td class="text-center">{{ service.estimatedHours }}</td>
              <td class="text-right">R$ {{ formatCurrency(service.pricePerHour) }}</td>
              <td class="text-right font-medium">R$ {{ formatCurrency(service.totalPrice) }}</td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="text-right font-medium">Total Serviços:</td>
              <td class="text-right font-bold">R$ {{ formatCurrency(serviceOrder.estimatedTotalServices) }}</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="budget-total-container">
        <div class="budget-total-row">
          <span class="total-label">Valor Total do Orçamento:</span>
          <span class="total-value">R$ {{ formatCurrency(serviceOrder.estimatedTotal) }}</span>
        </div>

        <div *ngIf="serviceOrder.estimatedCompletionDate" class="completion-date">
          <span class="completion-label">Previsão de Conclusão:</span>
          <span class="completion-value">{{ serviceOrder.estimatedCompletionDate | date:'dd/MM/yyyy' }}</span>
        </div>

        <div *ngIf="serviceOrder.technicalObservations" class="technical-notes">
          <h3 class="notes-title">Observações Técnicas:</h3>
          <p class="notes-content">{{ serviceOrder.technicalObservations }}</p>
        </div>
      </div>
    </div>

    <div *ngIf="approvalPending" class="budget-actions-container no-print">
      <div class="flex justify-center gap-4">
        <button (click)="approveBudget()" class="approve-button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Aprovar Orçamento
        </button>

        <button (click)="toggleRejectForm()" class="reject-button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" fill="none" viewBox="0 0 24 24"
            stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Rejeitar Orçamento
        </button>
      </div>

      <div *ngIf="showRejectForm" class="reject-form">
        <h3 class="reject-form-title">Motivo da Rejeição</h3>
        <textarea [(ngModel)]="rejectionReason" class="reject-textarea"
          placeholder="Digite o motivo da rejeição (opcional)..."></textarea>
        <div class="reject-actions">
          <button (click)="toggleRejectForm()" class="cancel-button">Cancelar</button>
          <button (click)="rejectBudget()" class="confirm-reject-button">Confirmar Rejeição</button>
        </div>
      </div>
    </div>
  </div>

  <div class="budget-approval-footer no-print">
    <p class="footer-text">© 2025 Smart Oficina</p>
  </div>
</div>